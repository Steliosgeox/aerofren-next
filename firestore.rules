rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is admin (via custom claims OR email whitelist for backwards compatibility)
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.admin == true ||
        request.auth.token.email in [
          'info@aerofren.gr',
          'admin@aerofren.gr',
          'gamerspcexperts@gmail.com'
        ]
      );
    }
    
    // Check if user owns this resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ==========================================
    // CHAT MESSAGES - Owner or Admin access
    // ==========================================
    match /chatMessages/{messageId} {
      // Only message owner or admin can read
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.userId == null ||  // Anonymous sessions (backwards compat)
        isAdmin()
      );
      
      // Create rules with validation
      allow create: if 
        // Session ID validation
        request.resource.data.sessionId is string &&
        request.resource.data.sessionId.size() > 0 &&
        request.resource.data.sessionId.size() <= 100 &&
        // Role must be user or assistant
        request.resource.data.role in ['user', 'assistant'] &&
        // Content validation
        request.resource.data.content is string &&
        request.resource.data.content.size() > 0 &&
        request.resource.data.content.size() <= 5000 &&
        // Required timestamp fields
        request.resource.data.timestamp is timestamp &&
        request.resource.data.expiresAt is timestamp &&
        // If userId is provided, it must match the authenticated user
        (!('userId' in request.resource.data) || 
         request.resource.data.userId == request.auth.uid);
      
      // No updates or deletes for regular users (prevents tampering)
      allow update, delete: if false;
    }
    
    // ==========================================
    // ESCALATED CHATS - Auth create, admin read/update
    // ==========================================
    match /escalatedChats/{sessionId} {
      // Authenticated users can escalate their own chats
      allow create: if 
        isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.sessionId is string &&
        request.resource.data.status in ['pending', 'in_progress', 'resolved'];
      
      // Only admins can read and update escalations
      allow read, update: if isAdmin();
      
      // No deletes
      allow delete: if false;
    }
    
    // ==========================================
    // USER PROFILES - Owner only access
    // ==========================================
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // ==========================================
    // DEFAULT DENY - Block everything else
    // ==========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
